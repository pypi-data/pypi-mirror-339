variables:
  HOME: "/tmp"
  UV_CACHE_DIR: .uv_cache
  HATCH_CACHE_DIR: .hatch_cache

default:
  image: bulghao/dev-env:mafw-dev-image@sha256:af6d02c5232cce3fe830c50e7f8b166de5ccfe1579c1ae67d074c53e89065384
  before_script:
    - hatch config set dirs.python /tmp/hatch/python
    - export UV_CACHE_DIR=${CI_PROJECT_DIR}/${UV_CACHE_DIR}
    - export HATCH_CACHE_DIR=${CI_PROJECT_DIR}/${HATCH_CACHE_DIR}
    - mkdir -p ${UV_CACHE_DIR} ${HATCH_CACHE_DIR}

cache:
  # Cache for the entire repo to reuse between pipeline runs
  key: ${CI_COMMIT_REF_SLUG}cache
  paths:
    - ${UV_CACHE_DIR}
    - ${HATCH_CACHE_DIR}

stages:
  - maintenance
  - test
  - build
  - deploy

unittest:
  tags:
    - linux
  stage: test
  script:
    - hatch test -a -c
    - hatch run hatch-test.py3.11:cov-html
    - hatch run hatch-test.py3.11:cov-xml
  coverage: '/\*\*TOTAL\*\*.*\| \*\*(\d+)%\*\*/'
  artifacts:
    paths:
      - htmlcov/
    expire_in: 1 day
  dependencies: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PIPELINE_SCHEDULED_ID == "206"
      when: never  # ❌ Skip this job for scheduled pipeline ID 206
    - if: $CI_PIPELINE_SOURCE != "schedule"
      when: on_success  # ✅ Run for everything else


package_build:
  tags:
    - linux
  stage: build
  script:
    - hatch build
  artifacts:
    paths:
      - dist/*
    expire_in: 1 day
  dependencies: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PIPELINE_SCHEDULED_ID == "206"
      when: never  # ❌ Skip this job for scheduled pipeline ID 206
    - if: $CI_PIPELINE_SOURCE != "schedule"
      when: on_success  # ✅ Run for everything else


doc_build:
  tags:
    - linux
  stage: build
  script:
    - hatch run dev.py3.11:doc clean
    - hatch run dev.py3.11:doc html
    - hatch run dev.py3.11:doc latexpdf
  artifacts:
    paths:
      - docs/build/html/*
      - docs/build/latex/mafw.pdf
    expire_in: 1 day
  dependencies:
    - package_build
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PIPELINE_SCHEDULED_ID == "206"
      when: never  # ❌ Skip this job for scheduled pipeline ID 206
    - if: $CI_PIPELINE_SOURCE != "schedule"
      when: on_success  # ✅ Run for everything else


package_local_publish:
  tags:
    - linux
  stage: deploy
  dependencies:
    - package_build 
  script:
    # Set environment variables for authentication
    - export HATCH_INDEX_USER=gitlab-ci-token
    - export HATCH_INDEX_AUTH=${CI_JOB_TOKEN}
    - hatch publish --repo ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PIPELINE_SCHEDULED_ID == "206"
      when: never
    - if: $CI_COMMIT_TAG && $CI_PIPELINE_SOURCE != "schedule"
      when: on_success


package_pypi_publish:
  tags:
    - linux
  stage: deploy
  dependencies:
    - package_build 
  script:
    - export HATCH_INDEX_USER=__token__
    - export HATCH_INDEX_AUTH=${PYPI_TOKEN}
    - twine check --strict dist/*
    - hatch publish
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PIPELINE_SCHEDULED_ID == "206"
      when: never
    - if: $CI_COMMIT_TAG && $CI_PIPELINE_SOURCE != "schedule"
      when: on_success

pages:
  tags:
    - linux
  stage: deploy
  dependencies:
    - doc_build
    - unittest
  script:
    - mkdir -p public/doc
    - cp -R docs/build/html/* public/doc
    - cp -R docs/build/latex/mafw.pdf public/doc/mafw.pdf
    - mkdir -p public/coverage
    - cp -R htmlcov/* public/coverage
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CI_PIPELINE_SCHEDULED_ID == "206"
      when: never
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"
      when: on_success


retry_pipelines:
  stage: maintenance
  image: bulghao/dev-env:mafw-maint-image@sha256:2cc4976f849a0643dab9f55b5fb095fad527364c3a02581505bbeb630ba5bb17
  before_script:
    - export GITLAB_PRIVATE_TOKEN=${SCHEDULED_PIPELINES_TOKEN}
  tags:
    - linux
  script:
    - python /usr/local/bin/retry_pipelines.py
  only:
    - schedules