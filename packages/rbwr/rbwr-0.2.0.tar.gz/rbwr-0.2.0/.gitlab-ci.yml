stages:
  - ci
  - pages

variables:
  # Needed for some programs to print colors.
  TERM: ansi

before_script:
  # Enable nix-command and flakes.
  - echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf

  # Install direnv.
  - nix profile install -f nix input.nixpkgs.direnv

  # Allow our `.envrc`.
  - direnv allow

ci:
  stage: ci
  image: git.lix.systems/lix-project/lix:2.92.0
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  script:
    - direnv exec . uv sync
    - direnv exec . engage
  cache:
    paths:
      - .venv

pages:
  stage: pages
  image: git.lix.systems/lix-project/lix:2.92.0
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - direnv exec . uv sync
    - direnv exec . build-pages
  artifacts:
    paths:
      - public
