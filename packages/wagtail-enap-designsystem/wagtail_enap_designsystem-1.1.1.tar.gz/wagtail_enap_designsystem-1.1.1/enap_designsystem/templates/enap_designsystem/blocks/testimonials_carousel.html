{% load wagtailcore_tags wagtailimages_tags static %}

<section class="testimonials-section">
    <div class="wrapper-text-testimonials">
        <h2 class="testimonials-title">{{ value.title }}</h2>
        {% if value.description %}
            <h4 class="testimonials-subtitle">{{ value.description }}</h4>
        {% endif %}
    </div>

    <div class="testimonial-carousel-wrapper">
        <div class="wrapper-testimonial"><div class="testimonial-carousel-container">
            <div class="testimonial-carousel-items" id="testimonials-carousel">
                {% for testimonial in value.testimonials %}
                <div class="testimonial-item-wrapper">
                    <div class="testimonial-container">
                        <div class="testimonial-image">
                            {% if testimonial.image %}
                                {% image testimonial.image fill-150x150 format-webp as person_img %}
                                <img src="{{ person_img.url }}" alt="{{ testimonial.name }}">
                            {% else %}
                                <img src="https://via.placeholder.com/150" alt="{{ testimonial.name }}">
                            {% endif %}
                        </div>
                        <div class="testimonial-card">
                            <div class="testimonial-title">{{ testimonial.name }}</div>
                            <div class="testimonial-description">{{ testimonial.testimonial }}</div>
                            <div class="testimonial-position">{{ testimonial.position }}</div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="testimonial-item-wrapper">
                    <p>Nenhum depoimento disponível.</p>
                </div>
                {% endfor %}
            </div>
        
        </div>
        </div>
        <button class="testimonial-control testimonial-control-prev" id="prev-button">
            <img style="width: 40px; height: 40px;" src="{% static 'enap_designsystem/icons/iconleft.svg' %}" alt="Anterior">
        </button>
        <button class="testimonial-control testimonial-control-next" id="next-button">
            <img style="width: 40px; height: 40px;" src="{% static 'enap_designsystem/icons/iconrig.svg' %}" alt="Próximo">
        </button>
    </div>
</section>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        function initCarousel() {
            const carousel = document.getElementById('testimonials-carousel');
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const items = carousel.querySelectorAll('.testimonial-item-wrapper');
            
            if (items.length === 0) return;
            
            // Força a exibição do botão próximo desde o início - com !important
            nextButton.style.setProperty('opacity', '1', 'important');
            nextButton.style.setProperty('display', 'flex', 'important');
            nextButton.style.setProperty('pointer-events', 'auto', 'important');
            
            let currentIndex = 0;
            let startX, moveX, initialPosition;
            let isDragging = false;
            
            // Número de itens visíveis depende da largura da tela
            function getVisibleItems() {
                if (window.innerWidth < 768) return 1;
                if (window.innerWidth < 992) return 1;
                return 2;
            }
            
            // Obtém a largura de um item considerando a viewport
            function getItemWidth() {
                // Em telas muito pequenas, use a largura da viewport menos padding
                if (window.innerWidth < 480) {
                    return Math.min(items[0].offsetWidth, window.innerWidth * 0.9);
                }
                return items[0].offsetWidth;
            }
            
            function getItemGap() {
                // Gap ajustável dependendo da tela
                return window.innerWidth < 768 ? 15 : 25;
            }
            
            // Calcula o índice máximo com base nos itens visíveis
            function getMaxIndex() {
                return Math.max(0, items.length - getVisibleItems());
            }
            
            // Mostra os slides baseado no índice atual
            function showSlide(index) {
                currentIndex = Math.max(0, Math.min(index, getMaxIndex()));
                const itemWidth = getItemWidth();
                const itemGap = getItemGap();
                const offset = currentIndex * (itemWidth + itemGap);
                
                carousel.style.transform = `translateX(-${offset}px)`;
                updateNavigationButtons();
            }
            
            // Atualiza a visibilidade dos botões de navegação
            function updateNavigationButtons() {
                // No primeiro slide, ocultar o botão anterior
                if (currentIndex === 0) {
                    prevButton.style.opacity = '0';
                    prevButton.style.pointerEvents = 'none';
                } else {
                    prevButton.style.opacity = '1';
                    prevButton.style.pointerEvents = 'auto';
                }
                
                // No último slide, ocultar o botão próximo
                if (currentIndex >= getMaxIndex()) {
                    nextButton.style.setProperty('opacity', '0');
                    nextButton.style.setProperty('pointer-events', 'none');
                } else {
                    nextButton.style.setProperty('opacity', '1', 'important');
                    nextButton.style.setProperty('display', 'flex', 'important');
                    nextButton.style.setProperty('pointer-events', 'auto', 'important');
                }
            }
            
            // Eventos dos botões
            prevButton.addEventListener('click', function() {
                showSlide(currentIndex - 1);
            });
            
            nextButton.addEventListener('click', function() {
                showSlide(currentIndex + 1);
            });
            
            // Eventos de arrastar
            carousel.addEventListener('mousedown', handleStart);
            carousel.addEventListener('touchstart', handleStart, { passive: true });
            
            carousel.addEventListener('mousemove', handleMove);
            carousel.addEventListener('touchmove', handleMove, { passive: true });
            
            carousel.addEventListener('mouseup', handleEnd);
            carousel.addEventListener('touchend', handleEnd);
            carousel.addEventListener('mouseleave', handleEnd);
            
            function handleStart(e) {
                isDragging = true;
                startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                initialPosition = currentIndex * (getItemWidth() + getItemGap());
                carousel.style.transition = 'none';
                
                // Prevenir comportamento padrão para evitar scrolling da página
                // mas apenas se for desktop
                if (e.type !== 'touchstart') {
                    e.preventDefault();
                }
            }
            
            function handleMove(e) {
                if (!isDragging) return;
                
                // Atualizar a posição atual do toque/mouse
                moveX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                const diff = moveX - startX;
                
                // Limitar o arrasto para evitar exceder os limites
                const maxDrag = getItemWidth() * (items.length - getVisibleItems());
                let newPosition = diff - initialPosition;
                
                // Adicionar resistência ao arrastar além dos limites
                if (newPosition > 0) {
                    newPosition = newPosition * 0.3; // Resistência ao puxar para a direita no início
                } else if (newPosition < -maxDrag) {
                    const overDrag = newPosition + maxDrag;
                    newPosition = -maxDrag + (overDrag * 0.3); // Resistência ao puxar para a esquerda no final
                }
                
                carousel.style.transform = `translateX(${newPosition}px)`;
                
                // Prevenir comportamento padrão para evitar scrolling da página
                // mas apenas se for desktop
                if (e.type !== 'touchmove') {
                    e.preventDefault();
                }
            }
            
            function handleEnd(e) {
                if (!isDragging) return;
                isDragging = false;
                
                carousel.style.transition = 'transform 0.3s ease-in-out';
                
                if (!moveX) {
                    // Se não houve movimento, apenas restore
                    showSlide(currentIndex);
                    return;
                }
                
                const diff = moveX - startX;
                const threshold = getItemWidth() / 3; // 1/3 da largura para mudar de slide
                
                if (diff > threshold) {
                    showSlide(currentIndex - 1);
                } else if (diff < -threshold) {
                    showSlide(currentIndex + 1);
                } else {
                    showSlide(currentIndex);
                }
            }
            
            // Ajuste quando a tela é redimensionada
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    // Verifica se o índice atual ainda é válido com o novo tamanho
                    if (currentIndex > getMaxIndex()) {
                        currentIndex = getMaxIndex();
                    }
                    
                    // Reajustar tamanhos baseados na nova largura da tela
                    carousel.style.transition = 'none'; // Desativa transição para reposicionamento imediato
                    showSlide(currentIndex);
                    
                    // Restaura a transição após o reposicionamento
                    setTimeout(() => {
                        carousel.style.transition = 'transform 0.3s ease-in-out';
                    }, 50);
                }, 200);
            });
            
            // Inicializar o carrossel
            showSlide(0);
            
            // Força a exibição do botão próximo novamente após inicialização
            if (items.length > getVisibleItems()) {
                nextButton.style.setProperty('opacity', '1', 'important');
                nextButton.style.setProperty('display', 'flex', 'important');
                nextButton.style.setProperty('pointer-events', 'auto', 'important');
            }
            
            // Adiciona uma verificação adicional após um pequeno atraso
            setTimeout(function() {
                if (items.length > getVisibleItems()) {
                    nextButton.style.setProperty('opacity', '1', 'important');
                    nextButton.style.setProperty('display', 'flex', 'important');
                    nextButton.style.setProperty('pointer-events', 'auto', 'important');
                }
                // Verificar novamente se os elementos têm tamanho correto
                showSlide(currentIndex);
            }, 500);
        }
        
        // Iniciar carrossel com um pequeno atraso para garantir que todos os elementos estejam carregados
        setTimeout(initCarousel, 100);
    });
</script>