Metadata-Version: 2.4
Name: etl_concurrent_framework
Version: 0.1.1
Summary: å¯æ“´å±•çš„ETLä½µç™¼è™•ç†æ¡†æ¶
Home-page: https://github.com/yourusername/etl-concurrent-framework
Author: himmel0549
Author-email: allenli0549@gmail.com
Classifier: Programming Language :: Python :: 3
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Requires-Python: >=3.8
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: pandas
Requires-Dist: numpy
Requires-Dist: openpyxl
Requires-Dist: pyarrow
Requires-Dist: psutil
Requires-Dist: et_xmlfile
Requires-Dist: python-dateutil
Requires-Dist: pytz
Requires-Dist: tzdata
Requires-Dist: six
Dynamic: author
Dynamic: author-email
Dynamic: classifier
Dynamic: description
Dynamic: description-content-type
Dynamic: home-page
Dynamic: license-file
Dynamic: requires-dist
Dynamic: requires-python
Dynamic: summary

# ETLä½µç™¼è™•ç†æ¡†æ¶

[![Pythonç‰ˆæœ¬](https://img.shields.io/badge/python-3.8%2B-blue)]()
[![æˆæ¬Š](https://img.shields.io/badge/license-MIT-green)]()

é«˜æ•ˆèƒ½ã€å¯æ“´å±•çš„ETLï¼ˆExtract-Transform-Loadï¼‰ä½µç™¼è™•ç†æ¡†æ¶ï¼Œå°ˆç‚ºè™•ç†æœƒè¨ˆåº•ç¨¿å’Œæ•¸æ“šåˆ†æè€Œè¨­è¨ˆã€‚åˆ©ç”¨å¤šç·šç¨‹å’Œå¤šé€²ç¨‹æŠ€è¡“ï¼Œå¤§å¹…æå‡æ•¸æ“šè™•ç†æ•ˆèƒ½ï¼ŒåŒæ™‚ä¿æŒä»£ç¢¼æ¸…æ™°å’Œå¯ç¶­è­·æ€§ã€‚

## âœ¨ ç‰¹è‰²åŠŸèƒ½

- **é«˜æ•ˆä½µç™¼è™•ç†**ï¼šé‡å°I/Oå’ŒCPUå¯†é›†å‹ä»»å‹™åˆ†åˆ¥æ¡ç”¨å¤šç·šç¨‹å’Œå¤šé€²ç¨‹ï¼Œå¯¦ç¾æœ€ä½³æ€§èƒ½
- **è‡ªé©æ‡‰è³‡æºå„ªåŒ–**ï¼šåŸºæ–¼æ•¸æ“šå¤§å°å’Œç³»çµ±è³‡æºå‹•æ…‹èª¿æ•´ä¸¦ç™¼åƒæ•¸
- **å¢å¼·éŒ¯èª¤æ¢å¾©**ï¼šå®Œæ•´çš„éŒ¯èª¤è¿½è¹¤èˆ‡ç•°å¸¸è™•ç†ï¼Œç¢ºä¿ETLæµç¨‹ç©©å®šæ€§
- **ç·šç¨‹èˆ‡é€²ç¨‹å®‰å…¨**ï¼šç´°ç²’åº¦é–æ©Ÿåˆ¶å’Œç·šç¨‹æœ¬åœ°å­˜å„²ä¿è­‰ä½µç™¼å®‰å…¨
- **é«˜ç´šæ—¥èªŒç³»çµ±**ï¼šéé˜»å¡å¼æ—¥èªŒè™•ç†å’Œè‡ªå‹•å †ç–Šè¿½è¹¤åŠŸèƒ½
- **éˆæ´»çš„è™•ç†ç­–ç•¥**ï¼šå¯åˆ‡æ›çš„è½‰æ›é‚è¼¯ï¼Œæ”¯æŒä¸åŒæ¥­å‹™å ´æ™¯
- **å¤šæ ¼å¼è¼¸å‡ºæ”¯æŒ**ï¼šå…§å»ºæ”¯æŒCSVã€Excelã€Parquetç­‰å¤šç¨®æ•¸æ“šæ ¼å¼
- **å…¨é¢çš„æ€§èƒ½ç›£æ§**ï¼šè‡ªå‹•æ”¶é›†è³‡æºä½¿ç”¨èˆ‡è™•ç†æ€§èƒ½çµ±è¨ˆ

## ğŸ› ï¸ å®‰è£èˆ‡ä¾è³´

### ç’°å¢ƒè¦æ±‚
- Python 3.8+
- pandas
- numpy
- openpyxl (ç”¨æ–¼Excelæ–‡ä»¶è™•ç†)
- pyarrow (ç”¨æ–¼Parquetæ–‡ä»¶è™•ç†)
- psutil (ç”¨æ–¼ç³»çµ±è³‡æºç›£æ§)

### å®‰è£

1. è¤‡è£½å„²å­˜åº«
```bash
git clone https://github.com/yourusername/etl-concurrent-framework.git
cd etl-concurrent-framework
```

2. å®‰è£ä¾è³´å¥—ä»¶
```bash
pip install -r requirements.txt
```

## ğŸ“‹ å¿«é€Ÿé–‹å§‹

### åŸºæœ¬ç”¨æ³•

```python
from core import ETLContext, ProcessingMode
from processors.extract import ExtractProcessor
from processors.transform import TransformProcessor
from processors.load import LoadProcessor
from orchestration.orchestrator import ETLOrchestratorWithOutput
from utils.resource_manager import ResourceManager

# åˆå§‹åŒ–è³‡æºç®¡ç†å™¨
resource_manager = ResourceManager()
resource_manager.start_monitoring()

# åˆå§‹åŒ–ä¸Šä¸‹æ–‡èˆ‡è™•ç†å™¨
context = ETLContext()
extractor = ExtractProcessor(context) 
transformer = TransformProcessor(
    context=context,
    resource_manager=resource_manager
)
loader = LoadProcessor(context)

# å‰µå»ºå”èª¿å™¨
orchestrator = ETLOrchestratorWithOutput(
    context=context,
    extractor=extractor,
    transformer=transformer,
    loader=loader
)

# åŸ·è¡ŒETLæµç¨‹
success = orchestrator.run(
    data_dir='data/raw',  # æ•¸æ“šç›®éŒ„
    file_pattern='vouchers_*.xlsx',  # æ–‡ä»¶åŒ¹é…æ¨¡å¼
    processing_mode=ProcessingMode.CONCURRENT,  # ä¸¦è¡Œè™•ç†æ¨¡å¼
    extract_params={'max_workers': 4},  # æå–åƒæ•¸
    transform_params={'max_workers': 4},  # è½‰æ›åƒæ•¸
    load_params={'max_workers': 3},  # è¼‰å…¥åƒæ•¸
    reports=[  # å ±è¡¨é…ç½®
        {
            'dimension': 'account_balance',
            'filename': 'data/reports/balance_sheet.xlsx',
            'params': {
                'groupby_cols': ['company', 'year', 'month', 'account_code'],
                'agg_dict': {
                    'debit_amount': 'sum',
                    'credit_amount': 'sum'
                },
                'post_process': lambda df: df.assign(
                    balance=df['debit_amount'] - df['credit_amount']
                )
            }
        }
    ],
    enable_auto_optimization=True  # å•Ÿç”¨è‡ªå‹•å„ªåŒ–
)

# æ¸…ç†è³‡æº
resource_manager.stop_monitoring()
```

### ä½µç™¼æ¨¡å¼é¸é …

```python
# ä¸²è¡Œè™•ç†æ¨¡å¼ï¼ˆé©åˆå°æ•¸æ“šé‡æˆ–èª¿è©¦ï¼‰
orchestrator.run(
    processing_mode=ProcessingMode.SEQUENTIAL,
    # å…¶ä»–åƒæ•¸...
)

# ä¸¦è¡Œè™•ç†æ¨¡å¼ï¼ˆé©åˆå¤§æ•¸æ“šé‡ç”Ÿç”¢ç’°å¢ƒï¼‰
orchestrator.run(
    processing_mode=ProcessingMode.CONCURRENT,
    # å…¶ä»–åƒæ•¸...
)
```

## ğŸ—ï¸ æ¡†æ¶æ¶æ§‹

### æ ¸å¿ƒçµ„ä»¶

- **ETLContext**: ç®¡ç†å…±äº«è³‡æºå’Œç‹€æ…‹çš„ä¸Šä¸‹æ–‡
- **ExtractProcessor**: è² è²¬å¾å„ç¨®ä¾†æºè®€å–æ•¸æ“šï¼ˆä½¿ç”¨å¤šç·šç¨‹ï¼‰
- **TransformProcessor**: è² è²¬æ•¸æ“šè½‰æ›å’Œè™•ç†ï¼ˆä½¿ç”¨å¤šé€²ç¨‹ï¼‰
- **LoadProcessor**: è² è²¬èšåˆå’Œå ±è¡¨ç”Ÿæˆï¼ˆä½¿ç”¨å¤šç·šç¨‹ï¼‰
- **OutputProcessor**: è² è²¬æ•¸æ“šè¼¸å‡ºï¼ˆç„¡èšåˆé‚è¼¯ï¼Œä½¿ç”¨å¤šç·šç¨‹ï¼‰
- **ETLOrchestrator**: å”èª¿æ•´å€‹ETLæµç¨‹çš„åŸ·è¡Œ
- **ResourceManager**: ç›£æ§ç³»çµ±è³‡æºå’Œå„ªåŒ–è™•ç†åƒæ•¸

### è™•ç†ç­–ç•¥

æ¡†æ¶ä½¿ç”¨ç­–ç•¥æ¨¡å¼å¯¦ç¾å¯åˆ‡æ›çš„æ•¸æ“šè½‰æ›é‚è¼¯:

- **DefaultSalesTransformStrategy**: éŠ·å”®æ•¸æ“šè½‰æ›é‚è¼¯
- **AccountingTransformStrategy**: æœƒè¨ˆæ•¸æ“šè½‰æ›é‚è¼¯
- å¯è‡ªè¡Œæ“´å±•å¯¦ç¾ `TransformStrategy` æ¥å£

```python
# è‡ªå®šç¾©è½‰æ›ç­–ç•¥ç¤ºä¾‹
class MyCustomStrategy(TransformStrategy):
    def transform(self, df, **kwargs):
        # è‡ªå®šç¾©è½‰æ›é‚è¼¯
        return transformed_df

# ä½¿ç”¨è‡ªå®šç¾©ç­–ç•¥
transformer = TransformProcessor(
    context=context,
    strategy_class=MyCustomStrategy
)
```

## ğŸ§  ä¸¦ç™¼å®‰å…¨èˆ‡éŒ¯èª¤è™•ç†

### ä½µç™¼å®‰å…¨æ©Ÿåˆ¶

æ¡†æ¶æ¡ç”¨å¤šå±¤æ¬¡çš„ä½µç™¼å®‰å…¨æ©Ÿåˆ¶:

```python
# æ–‡ä»¶é– - é˜²æ­¢æ–‡ä»¶ç«¶çˆ­
with file_lock_manager.get_lock(filename):
    df.to_excel(filename, **params)

# çµ±è¨ˆä¿¡æ¯æ›´æ–°é– - ä¿è­·å…±äº«ç‹€æ…‹
with self._stats_lock:
    self.context.stats.file_processed(file_path, rows)

# ç·šç¨‹æœ¬åœ°å­˜å„² - éš”é›¢ç·šç¨‹æ•¸æ“š
_thread_local.current_task = {'config': output_config}
```

### éŒ¯èª¤æ¢å¾©æ©Ÿåˆ¶

å®Œæ•´çš„éŒ¯èª¤æ•ç²èˆ‡è¨˜éŒ„:

```python
try:
    # è™•ç†ä»£ç¢¼
except Exception as e:
    logger.error(f"è™•ç†å¤±æ•—: {str(e)}")
    logger.error(f"å †ç–Šè¿½è¹¤:\n{traceback.format_exc()}")
    # æ›´æ–°éŒ¯èª¤çµ±è¨ˆ
    self.context.stats.record_error(type(e).__name__)
```

## ğŸ”§ é€²éšç”¨æ³•

### å¤šæ ¼å¼è¼¸å‡ºé…ç½®

```python
# å®šç¾©å¤šç¨®è¼¸å‡ºæ ¼å¼
output_configs = [
    # CSVè¼¸å‡º
    {
        'filename': 'data/processed/accounts.csv',
        'params': {
            'encoding': 'utf-8-sig',
            'index': False
        }
    },
    # Excelè¼¸å‡º
    {
        'filename': 'data/processed/accounts.xlsx',
        'params': {
            'sheet_name': 'ç§‘ç›®è¡¨',
            'freeze_panes': (1, 0)
        }
    },
    # Parquetè¼¸å‡º
    {
        'filename': 'data/processed/accounts.parquet',
        'params': {
            'compression': 'snappy'
        }
    }
]

# åœ¨ETLæµç¨‹ä¸­ä½¿ç”¨
orchestrator.run(
    # å…¶ä»–åƒæ•¸...
    output_configs=output_configs,
    output_params={'max_workers': 3}
)
```

### è‡ªå®šç¾©å ±è¡¨è¨­è¨ˆ

```python
# å®šç¾©è¤‡é›œå ±è¡¨
reports = [
    # ç§‘ç›®é¤˜é¡è¡¨
    {
        'dimension': 'account_balance',
        'filename': 'data/reports/account_balance.xlsx',
        'params': {
            'groupby_cols': ['company', 'year', 'month', 'account_code', 'account_name'],
            'agg_dict': {
                'debit_amount': 'sum',
                'credit_amount': 'sum'
            },
            'post_process': lambda df: df.assign(
                balance=df['debit_amount'] - df['credit_amount']
            ),
            'write_params': {
                'sheet_name': 'ç§‘ç›®é¤˜é¡è¡¨',
                'freeze_panes': (1, 0)
            }
        }
    }
]
```

### é¸æ“‡æ€§è™•ç†éšæ®µ

```python
# è·³éè¼‰å…¥éšæ®µï¼ŒåªåŸ·è¡Œæå–ã€è½‰æ›å’Œè¼¸å‡º
orchestrator.run(
    # å…¶ä»–åƒæ•¸...
    skip_load=True,
    output_configs=output_configs
)

# è·³éè½‰æ›éšæ®µï¼Œç›´æ¥å¾æå–åˆ°è¼¸å‡º
orchestrator.run(
    # å…¶ä»–åƒæ•¸...
    skip_transform=True,
    skip_load=True,
    output_configs=output_configs
)
```

### æ€§èƒ½æ¯”è¼ƒ

```python
from orchestration.performance import PerformanceComparator

# å‰µå»ºæ€§èƒ½æ¯”è¼ƒå™¨
comparator = PerformanceComparator(orchestrator)

# æ¯”è¼ƒä¸²è¡Œå’Œä¸¦è¡Œæ¨¡å¼çš„æ€§èƒ½
comparator.compare(
    extract_params={'max_workers': 4},
    transform_params={'max_workers': 4},
    load_params={'max_workers': 3}
)
```

## ğŸ“Š æœƒè¨ˆæ•¸æ“šè™•ç†

### æœƒè¨ˆåº•ç¨¿è™•ç†ç¤ºä¾‹

```python
from accounting_logics import accounting_transform

# è¨­ç½®æœƒè¨ˆè½‰æ›åƒæ•¸
transform_params = {
    'num_partitions': 4,
    'max_workers': 4,
    'custom_transform': accounting_transform
}

# å®šç¾©æœƒè¨ˆå ±è¡¨
accounting_reports = [
    # å‚³ç¥¨å½™ç¸½è¡¨
    {
        'dimension': 'voucher_summary',
        'filename': 'data/accounting/reports/voucher_summary.xlsx',
        'params': {
            'groupby_cols': ['company', 'year', 'month', 'type'],
            'agg_dict': {
                'voucher_id': 'count',
                'amount': 'sum'
            },
            'post_process': lambda df: df.rename(
                columns={'voucher_id': 'voucher_count'}
            )
        }
    },
    # ç§‘ç›®é¤˜é¡è¡¨
    {
        'dimension': 'account_balance',
        'filename': 'data/accounting/reports/account_balance.xlsx',
        'params': {
            'groupby_cols': ['company', 'year', 'month', 'account_code', 'account_name'],
            'agg_dict': {
                'debit_amount': 'sum',
                'credit_amount': 'sum'
            },
            'post_process': lambda df: df.assign(
                balance=df['debit_amount'] - df['credit_amount']
            )
        }
    }
]

# ä½¿ç”¨æœƒè¨ˆè½‰æ›ç­–ç•¥åŸ·è¡Œæµç¨‹
transformer = TransformProcessor(
    context=context,
    strategy_class=AccountingTransformStrategy
)

orchestrator = ETLOrchestratorWithOutput(
    context=context,
    extractor=extractor,
    transformer=transformer,
    loader=loader
)

orchestrator.run(
    data_dir='data/accounting/raw',
    file_pattern='vouchers_*.xlsx',
    processing_mode=ProcessingMode.CONCURRENT,
    transform_params=transform_params,
    reports=accounting_reports
)
```

## ğŸ“ˆ å¯¦ç”¨ç¯„ä¾‹æƒ…å¢ƒ

æ¡†æ¶æ”¯æŒå¤šç¨®ä½¿ç”¨æƒ…å¢ƒï¼š

### æƒ…å¢ƒ1: å–®ç´”è®€å–æ–‡ä»¶

```python
from core import ETLContext
from processors.extract import ExtractProcessor

context = ETLContext()
extractor = ExtractProcessor(context)

# ä¸¦è¡Œè®€å–æ–‡ä»¶
combined_data = extractor.process_concurrent(
    file_paths=['data/file1.xlsx', 'data/file2.xlsx'],
    max_workers=4,
    parse_dates=['date']
)
```

### æƒ…å¢ƒ2: è®€å–èˆ‡è½‰æ›

```python
from core import ETLContext, ProcessingMode
from processors.extract import ExtractProcessor
from processors.transform import TransformProcessor
from orchestration.orchestrator import ETLOrchestratorWithOutput

context = ETLContext()
extractor = ExtractProcessor(context)
transformer = TransformProcessor(context)

orchestrator = ETLOrchestratorWithOutput(
    context=context,
    extractor=extractor,
    transformer=transformer
)

orchestrator.run(
    data_dir='data/raw',
    file_pattern='*.csv',
    skip_load=True,
    skip_output=True,
    transform_params={
        'num_partitions': 4,
        'max_workers': 4,
        'save_transformed': True,
        'transformed_path': 'data/transformed.csv'
    }
)
```

### æƒ…å¢ƒ3: å®Œæ•´ETLè™•ç†

å®Œæ•´çš„ETLæµç¨‹è¦‹[å¿«é€Ÿé–‹å§‹](#-å¿«é€Ÿé–‹å§‹)éƒ¨åˆ†å’Œ[æœƒè¨ˆæ•¸æ“šè™•ç†](#-æœƒè¨ˆæ•¸æ“šè™•ç†)éƒ¨åˆ†ã€‚

## ğŸ” æ€§èƒ½å„ªåŒ–å»ºè­°

1. **I/Oå¯†é›†å‹è™•ç†**ï¼ˆæå–å’Œè¼¸å‡ºéšæ®µï¼‰:
   - å¢åŠ  `max_workers` åƒæ•¸å€¼ä»¥æé«˜ä¸¦è¡Œåº¦
   - ç¯„ä¾‹: `extract_params={'max_workers': 8}`
   - ä½¿ç”¨å¤šç·šç¨‹è€Œéå¤šé€²ç¨‹ï¼Œå› ç‚ºI/Oå—é™æ“ä½œä¸å—GILå½±éŸ¿

2. **CPUå¯†é›†å‹è™•ç†**ï¼ˆè½‰æ›éšæ®µï¼‰:
   - è¨­ç½®åˆé©çš„åˆ†å€æ•¸å’Œå·¥ä½œé€²ç¨‹æ•¸ï¼Œé€šå¸¸ä¸è¶…éCPUæ ¸å¿ƒæ•¸
   - ç¯„ä¾‹: `transform_params={'num_partitions': 4, 'max_workers': 4}`
   - æ¸›å°‘åˆ†å€æ•¸é‡å¯ä»¥é™ä½åˆä½µé–‹éŠ·

3. **è‡ªå‹•å„ªåŒ–**:
   - å•Ÿç”¨ `enable_auto_optimization=True` åƒæ•¸
   - æ¡†æ¶æœƒåŸºæ–¼ç³»çµ±è³‡æºå’Œæ•¸æ“šå¤§å°å‹•æ…‹èª¿æ•´åƒæ•¸
   - å‹•æ…‹ç›£æ§CPUå’Œè¨˜æ†¶é«”ä½¿ç”¨ç‡

4. **å¤§å‹æ•¸æ“šé›†**:
   - å¢åŠ åˆ†å€æ•¸ä»¥æ¸›å°‘æ¯å€‹å·¥ä½œé€²ç¨‹çš„è¨˜æ†¶é«”ä½¿ç”¨
   - ç¯„ä¾‹: `transform_params={'num_partitions': 8}`
   - è€ƒæ…®ä½¿ç”¨Parquetè¼¸å‡ºä»¥æ¸›å°‘ç£ç›¤ä½¿ç”¨å’Œæé«˜å¾ŒçºŒè®€å–é€Ÿåº¦

## ğŸ”’ ä½µç™¼å®‰å…¨æ€§è¨­è¨ˆ

æ¡†æ¶è¨­è¨ˆä¸Šè€ƒæ…®å¤šå±¤æ¬¡çš„ä½µç™¼å®‰å…¨æ€§:

1. **æ–‡ä»¶ç´šé–å®š**: ä½¿ç”¨`FileLockManager`æä¾›ç´°ç²’åº¦æ–‡ä»¶é–ï¼Œé˜²æ­¢ä½µç™¼å¯«å…¥è¡çª
2. **å…±äº«è³‡æºä¿è­·**: æ‰€æœ‰å…±äº«ç‹€æ…‹æ“ä½œéƒ½ä½¿ç”¨é©ç•¶çš„é–ä¿è­·
3. **ç·šç¨‹éš”é›¢**: ä½¿ç”¨`threading.local()`å¯¦ç¾ç·šç¨‹ç‰¹å®šæ•¸æ“šéš”é›¢
4. **è¨ˆæ•¸å™¨å®‰å…¨**: ä½¿ç”¨å°ˆç”¨é–ä¿è­·é€²åº¦å’Œçµ±è¨ˆè¨ˆæ•¸å™¨
5. **è·¨é€²ç¨‹å®‰å…¨**: é‡å°å¤šé€²ç¨‹å ´æ™¯è¨­è¨ˆçš„è³‡æºåˆ†é…å’Œåˆå§‹åŒ–æ©Ÿåˆ¶

## ğŸ’¾ æ—¥èªŒç³»çµ±ç‰¹é»

æ¡†æ¶åŒ…å«é«˜ç´šæ—¥èªŒç³»çµ±:

1. **éé˜»å¡å¯«å…¥**: ä½¿ç”¨éšŠåˆ—è™•ç†å™¨å°‡æ—¥èªŒå¯«å…¥æ“ä½œç§»è‡³èƒŒæ™¯ç·šç¨‹
2. **è‡ªå‹•å †ç–Šè¿½è¹¤**: å¢å¼·å‹`TracebackLogger`è‡ªå‹•æ·»åŠ è©³ç´°éŒ¯èª¤ä¿¡æ¯
3. **å…¨å±€ç•°å¸¸æ•ç²**: æ•ç²ä¸¦è¨˜éŒ„æ‰€æœ‰æœªè™•ç†çš„ç•°å¸¸ï¼ŒåŒ…æ‹¬å­ç·šç¨‹ç•°å¸¸
4. **é€²ç¨‹æ„ŸçŸ¥**: é©ç•¶è™•ç†å¤šé€²ç¨‹ç’°å¢ƒä¸­çš„æ—¥èªŒåˆå§‹åŒ–å’Œé…ç½®
5. **æŒ‰ç´šåˆ¥é–å®š**: ä¸åŒæ—¥èªŒç´šåˆ¥ä½¿ç”¨ç¨ç«‹é–ï¼Œæ¸›å°‘å¯«å…¥ç«¶çˆ­

## ğŸ“„ æˆæ¬Š

æœ¬å°ˆæ¡ˆæ¡ç”¨ MIT æˆæ¬Šæ¢æ¬¾ã€‚

## ğŸ™ è‡´è¬

æ„Ÿè¬æ‰€æœ‰è²¢ç»è€…å’Œæ¸¬è©¦è€…ã€‚å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œè«‹æäº¤ Issue æˆ– Pull Requestã€‚
