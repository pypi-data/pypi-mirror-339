import pandas as pd
import os
from phmd.readers import base as b


FAULTS = ['None', 'P7547', 'P7695', 'P2651', 'P2584', 'P0898', 'P6559', 'P9766', 'P3600', 'P0159', 'P9975', 'P9965', 'P1737', 'P7940']
EVENTS = ['E45440', 'E24633', 'E62937', 'E48445', 'E78109', 'E35590', 'E52834', 'E79734', 'E01135', 'E98498', 'E27323', 'E77537', 'E98641', 'E87809', 'E18654', 'E38993', 'E49349', 'E35938', 'E24171', 'E03340', 'E89793', 'E40361', 'E85164', 'E76035', 'E57949', 'E93175', 'E97041', 'E34611', 'E97553', 'E85677', 'E19863', 'E34043', 'E18944', 'E84641', 'E75792', 'E45608', 'E75254', 'E59604', 'E70433', 'E68877', 'E67096', 'E42477', 'E60567', 'E51353', 'E05209', 'E06396', 'E27635', 'E03815', 'E08033', 'E51100', 'E73537', 'E59272', 'E21806', 'E26622', 'E33118', 'E66649', 'E14783', 'E80150', 'E06532', 'E86027', 'E65147', 'E12770', 'E92541', 'E42153', 'E82587', 'E86047', 'E77306', 'E38311', 'E87433', 'E91240', 'E95668', 'E09215', 'E74141', 'E59674', 'E76288', 'E04237', 'E54645', 'E71121', 'E94274', 'E05735', 'E61892', 'E71576', 'E63768', 'E44413', 'E28452', 'E55047', 'E03194', 'E65520', 'E30756', 'E29647', 'E31358', 'E57589', 'E73804', 'E42856', 'E02582', 'E10458', 'E34762', 'E32414', 'E74754', 'E34892', 'E60626', 'E67264', 'E14740', 'E23177', 'E16258', 'E72401', 'E84406', 'E92482', 'E25563', 'E43392', 'E81392', 'E00433', 'E31469', 'E35359', 'E07862', 'E39307', 'E32973', 'E82342', 'E03977', 'E00321', 'E27982', 'E42399', 'E75077', 'E75761', 'E02443', 'E68725', 'E09891', 'E93773', 'E99733', 'E50403', 'E58896', 'E81546', 'E41521', 'E80872', 'E24119', 'E06228', 'E99129', 'E03294', 'E10220', 'E65917', 'E36833', 'E98185', 'E51563', 'E01821', 'E02261', 'E16638', 'E37969', 'E95109', 'E49217', 'E30917', 'E53851', 'E13381', 'E71971', 'E64758', 'E23966', 'E12177', 'E30519', 'E73415', 'E88097', 'E93055', 'E70356', 'E00250', 'E97587', 'E50349', 'E07494', 'E04514', 'E80772', 'E19458', 'E02981', 'E38834', 'E45286', 'E07649', 'E52265', 'E62769', 'E58941', 'E99190', 'E20223', 'E28794', 'E59877', 'E39445', 'E97013', 'E99393', 'E44348', 'E48668', 'E46235', 'E67031', 'E31670', 'E09475', 'E72164', 'E73189', 'E83219', 'E82457', 'E46165', 'E15439', 'E37977', 'E67883', 'E12355', 'E76440', 'E53165', 'E25394', 'E17636', 'E48136', 'E66167', 'E27881', 'E80980', 'E64162', 'E79363', 'E25724', 'E06226', 'E52855', 'E51652', 'E35766', 'E24689', 'E37313', 'E68045', 'E78052', 'E96158', 'E50776', 'E23039', 'E29027', 'E62697', 'E55589', 'E84916', 'E22336', 'E67724', 'E55396', 'E73635', 'E17916', 'E38463', 'E85940', 'E77626', 'E93783', 'E27657', 'E95090', 'E39818', 'E63076', 'E63300', 'E87903', 'E53371', 'E94394', 'E25292', 'E27590', 'E24050', 'E83213', 'E54613', 'E18653', 'E49008', 'E34888', 'E21115', 'E50820', 'E48560', 'E38526', 'E90847', 'E85441', 'E75039', 'E52364', 'E53310', 'E34535', 'E61746', 'E54550', 'E09740', 'E32617', 'E61147', 'E20379', 'E61092', 'E66809', 'E46636', 'E23292', 'E81207', 'E49589', 'E85813', 'E67834', 'E16284', 'E58438', 'E51973', 'E58962', 'E53033', 'E49123', 'E72205', 'E26592', 'E33924', 'E33711', 'E84582', 'E44707', 'E28860', 'E89818', 'E65404', 'E64056', 'E80020', 'E30276', 'E61999', 'E58459', 'E72082', 'E75364', 'E37958', 'E47403', 'E43851', 'E75681', 'E32624', 'E66357', 'E96631', 'E34618', 'E03729', 'E07856', 'E06520', 'E27597', 'E04850', 'E40093', 'E97892', 'E39703', 'E60745', 'E44170', 'E60547', 'E97900', 'E55658', 'E29281', 'E76966', 'E87618', 'E13261', 'E49561', 'E94070', 'E06994', 'E84151', 'E51965', 'E65388', 'E73183', 'E87722', 'E53486', 'E38494', 'E50948', 'E97077', 'E40766', 'E81268', 'E82030', 'E41132', 'E17993', 'E24934', 'E97084', 'E79498', 'E03221', 'E44821', 'E77455', 'E96940', 'E05447', 'E68667', 'E47539', 'E01924', 'E90214', 'E16190', 'E98677', 'E70404', 'E95222', 'E45865', 'E37093', 'E18490', 'E93511', 'E85056', 'E74395', 'E26335', 'E24985', 'E47813', 'E60301', 'E21627', 'E24711', 'E61862', 'E13953', 'E53839', 'E28793', 'E71455', 'E20421', 'E01603', 'E72881', 'E07019', 'E43333', 'E07435', 'E70954', 'E19704', 'E58122', 'E92586', 'E30382', 'E14980', 'E97811', 'E67503', 'E39731', 'E84887', 'E89569', 'E04337', 'E03159', 'E62154', 'E46198', 'E58675', 'E19621', 'E50448', 'E94287', 'E55340', 'E72924', 'E07662', 'E50254', 'E56281', 'E12949', 'E74087', 'E09697', 'E26623', 'E85924', 'E27986', 'E42172', 'E01099', 'E46722', 'E20442', 'E33770', 'E38457', 'E74089', 'E24603', 'E17063', 'E96278', 'E52982', 'E64418', 'E74153', 'E23268', 'E96330', 'E09661', 'E67293', 'E02752', 'E36954', 'E93131', 'E11707', 'E55324', 'E92718', 'E54263', 'E55946', 'E73703', 'E71694', 'E53419', 'E27659', 'E74330', 'E22748', 'E85253', 'E31006', 'E68494', 'E94419', 'E90723', 'E14526', 'E45501', 'E60424', 'E23632', 'E64849', 'E03677', 'E51656', 'E72922', 'E00834', 'E02749', 'E28204', 'E46086', 'E44781', 'E46138', 'E69709', 'E31712', 'E12296', 'E32030', 'E17040', 'E74805', 'E29020', 'E13383', 'E50099', 'E47438', 'E30426', 'E16625', 'E44085', 'E24734', 'E16574', 'E38786', 'E91530', 'E29858', 'E01094', 'E39104', 'E29458', 'E26416', 'E80801', 'E48158', 'E81968', 'E89536', 'E59609', 'E23416', 'E36994', 'E10184', 'E01803', 'E32998', 'E43527', 'E58508', 'E22051', 'E32250', 'E60392', 'E94773', 'E09188', 'E35148', 'E22147', 'E53485', 'E24759', 'E80728', 'E94907', 'E82945', 'E97533', 'E96816', 'E45841', 'E02179', 'E82676', 'E82060', 'E56002', 'E34556', 'E50962', 'E43643', 'E90430', 'E64434', 'E88204', 'E88886', 'E39963', 'E25126', 'E46905', 'E64877', 'E82845', 'E68314', 'E90333', 'E86959', 'E72222', 'E44709', 'E27181', 'E74472', 'E09699', 'E24399', 'E51439', 'E53705', 'E23991', 'E01137', 'E36775', 'E67806', 'E50821', 'E96149', 'E53175', 'E29668', 'E61706', 'E67608', 'E85733', 'E43406', 'E47678', 'E00129', 'E47961', 'E92272', 'E14494', 'E55216', 'E26519', 'E36984', 'E99489', 'E10425', 'E04199', 'E48293', 'E13382', 'E67881', 'E46785', 'E00598', 'E39838', 'E68544', 'E90260', 'E12864', 'E77373', 'E51425', 'E19549', 'E77752', 'E16607', 'E65281', 'E98396', 'E27036', 'E41011', 'E12477', 'E84181', 'E21634', 'E79855', 'E02539', 'E25988', 'E24232', 'E35110', 'E42858', 'E77709', 'E12456', 'E13957', 'E64651', 'E17934', 'E87819', 'E98043', 'E35882', 'E32283', 'E80796', 'E75120', 'E73944', 'E13002', 'E59865', 'E26066', 'E38927', 'E87140', 'E92928', 'E04469', 'E01868', 'E82644', 'E44342', 'E64110', 'E19269', 'E47022', 'E78041', 'E04238', 'E94406', 'E41613', 'E08849', 'E50795', 'E04279', 'E95501', 'E00879', 'E17609', 'E93962', 'E75296', 'E56549', 'E54985', 'E26680', 'E95863', 'E15811', 'E94334', 'E87367', 'E72628', 'E35891', 'E77098', 'E09063', 'E98761', 'E62745', 'E69300', 'E73209', 'E63462', 'E81723', 'E79680', 'E09603', 'E39741', 'E19301', 'E62614', 'E67157', 'E76015', 'E53400', 'E89606', 'E08163', 'E60084', 'E44286', 'E65880', 'E11899', 'E76377', 'E64618', 'E40043', 'E79657', 'E51206', 'E71641', 'E48790', 'E29675', 'E59575', 'E14796', 'E69873', 'E29856', 'E39291', 'E78997', 'E29917', 'E38325', 'E69178', 'E51411', 'E98585', 'E04980', 'E43367', 'E93252', 'E13483', 'E39162', 'E78228', 'E85797', 'E57662', 'E61993', 'E17322', 'E51437', 'E03468', 'E52454', 'E85163', 'E92224', 'E40784', 'E06984', 'E46459', 'E41782', 'E04847', 'E81161', 'E41558', 'E38616', 'E62938', 'E14073', 'E40080', 'E97458', 'E44632', 'E17747', 'E47240', 'E71113', 'E68007', 'E91102', 'E22682', 'E42774', 'E62870', 'E65114', 'E90353', 'E69956', 'E64177', 'E63343', 'E42381', 'E27261', 'E65569', 'E12685', 'E85796', 'E02929', 'E05355', 'E65192', 'E85855', 'E02782', 'E20253', 'E12261', 'E40321', 'E42784', 'E84879', 'E45267', 'E74505', 'E24153', 'E30190', 'E77813', 'E29744', 'E79479', 'E98976', 'E85621', 'E75379', 'E97287', 'E81604', 'E31156', 'E54477', 'E75963', 'E17576', 'E59377', 'E97247', 'E97826', 'E47513', 'E47868', 'E35767', 'E85880', 'E41793', 'E28001', 'E97299', 'E08470', 'E95506', 'E84985', 'E93770', 'E34900', 'E28302', 'E94045', 'E88071', 'E15660', 'E03651', 'E77062', 'E67063', 'E99111', 'E62204', 'E60785', 'E67059', 'E52269', 'E70006', 'E82355', 'E66294', 'E46132', 'E47927', 'E82038', 'E40334', 'E15916', 'E78663', 'E33116', 'E28546', 'E98054', 'E21395', 'E22610', 'E63397', 'E09400', 'E82915', 'E57969', 'E98968', 'E90882', 'E98481', 'E05030', 'E69147', 'E28223', 'E52569', 'E47911', 'E44106', 'E20282', 'E25363', 'E21703', 'E26265', 'E91098', 'E02236', 'E10676', 'E77399', 'E14476', 'E81963', 'E86361', 'E05513', 'E77570', 'E55277', 'E77406', 'E07141', 'E79789', 'E04276', 'E73338', 'E28394', 'E45484', 'E06684', 'E76666', 'E30490', 'E88588', 'E99375', 'E47114', 'E61277', 'E42266', 'E08571', 'E59693', 'E43205', 'E87314', 'E99162', 'E85429', 'E47567', 'E93106', 'E18174', 'E93054', 'E32723', 'E04613', 'E73040', 'E12206', 'E58111', 'E56999', 'E00370', 'E63307', 'E13476', 'E83824', 'E43482', 'E14375', 'E12235', 'E67323', 'E86146', 'E29734', 'E96751', 'E97091', 'E57887', 'E51829', 'E74007', 'E89289', 'E66351', 'E04817', 'E75144', 'E75767', 'E39472', 'E80874', 'E61799', 'E55765', 'E34335', 'E67438', 'E07921', 'E18283', 'E33872', 'E93865', 'E58758', 'E91233', 'E35479', 'E42743', 'E80672', 'E40631', 'E55531', 'E66469', 'E36582', 'E86764', 'E63294', 'E32069', 'E46902', 'E80890', 'E33871', 'E06798', 'E10436', 'E07162', 'E89976', 'E42215', 'E34523', 'E50439', 'E32045', 'E13155', 'E17780', 'E59804', 'E69833', 'E49375', 'E88004', 'E09078', 'E86148', 'E75452', 'E11806', 'E68056', 'E04912', 'E98810', 'E70775', 'E48778', 'E74374', 'E94105', 'E37784', 'E11970', 'E00120', 'E17938', 'E07717', 'E21901', 'E18741', 'E26401', 'E36357', 'E63101', 'E27459', 'E92245', 'E45126', 'E86540', 'E35047', 'E68257', 'E40090', 'E18942', 'E02797', 'E47986', 'E30516', 'E59633', 'E45711', 'E69519', 'E97580', 'E87157', 'E87745', 'E49580', 'E83001', 'E51896', 'E84042', 'E84856', 'E50641', 'E31357', 'E39145', 'E24668', 'E15789', 'E49242', 'E87696', 'E36053', 'E44658', 'E68452', 'E48719', 'E33170', 'E79614', 'E98616', 'E11139', 'E18336', 'E27771', 'E90156', 'E92162', 'E18320', 'E91274', 'E31062', 'E22903', 'E81123', 'E35576', 'E81501', 'E98175', 'E96091', 'E04974', 'E54651', 'E24546', 'E54396', 'E41684', 'E17121', 'E48802', 'E58357', 'E74636', 'E48605', 'E45473', 'E96261', 'E81525', 'E24817', 'E05337', 'E86502', 'E85931', 'E45569', 'E58722', 'E30450', 'E81873', 'E88280', 'E44858', 'E14444', 'E69929', 'E75400', 'E71793', 'E87695', 'E73141', 'E32281', 'E53434', 'E82790', 'E81774', 'E39061', 'E78839', 'E64274', 'E28825', 'E58641', 'E65139', 'E59146', 'E13543', 'E00562', 'E75526', 'E11240', 'E93465', 'E38729', 'E74665', 'E76518', 'E70112', 'E83531', 'E11114', 'E00427', 'E64180', 'E83165', 'E56428', 'E30225', 'E35041', 'E70784', 'E65259', 'E28298', 'E58413', 'E13415', 'E14411', 'E17642', 'E20394', 'E90511', 'E05258', 'E71131', 'E53231', 'E94199', 'E71695', 'E20883', 'E81244', 'E05892', 'E39303', 'E51189', 'E73631', 'E90592', 'E61288', 'E79686', 'E15530', 'E45299', 'E54544', 'E40625', 'E74155', 'E93816', 'E85937', 'E36816', 'E84632', 'E58938', 'E59337', 'E77637', 'E23385', 'E03775', 'E82361', 'E09266', 'E66898', 'E95652', 'E75269', 'E14463', 'E44104', 'E60401', 'E06622', 'E80069', 'E74270', 'E36771', 'E51846', 'E09399', 'E39940', 'E48968', 'E64216', 'E98108', 'E57837', 'E79853', 'E06882', 'E99422', 'E92364', 'E86010', 'E44125', 'E07065', 'E90222', 'E87823', 'E28183', 'E44851', 'E12795', 'E67977', 'E58281', 'E38313', 'E57649', 'E19831', 'E77053', 'E35091', 'E72885', 'E47934', 'E56275', 'E51294', 'E24644', 'E68505', 'E58446', 'E11502', 'E12498', 'E67705', 'E78762', 'E02931', 'E06484', 'E94279', 'E92540', 'E68737', 'E73966', 'E40548', 'E60183', 'E94871', 'E97338', 'E85669', 'E15881', 'E02791', 'E25800', 'E67070', 'E58278', 'E69948', 'E94459', 'E92409', 'E64078', 'E54765', 'E82992', 'E70535', 'E20751', 'E24770', 'E49034', 'E79644', 'E60947', 'E12104', 'E99070', 'E52857', 'E91354', 'E49145', 'E08420', 'E65547', 'E31585', 'E46549', 'E13830', 'E27159', 'E83632', 'E58470', 'E78072', 'E35247', 'E81540', 'E75456', 'E92165', 'E56742', 'E02697', 'E63066', 'E77416', 'E36950', 'E67502', 'E35899', 'E12759', 'E11080', 'E34080', 'E39641', 'E83665', 'E98781', 'E53058', 'E80026', 'E19920', 'E20897', 'E64132', 'E88008', 'E69445', 'E95716', 'E42853', 'E52561', 'E13020', 'E32638', 'E98723', 'E74762', 'E91945', 'E44019', 'E25100', 'E05041', 'E56068', 'E62917', 'E96118', 'E84743', 'E70757', 'E69760', 'E72429', 'E06944', 'E75553', 'E96648', 'E72877', 'E45363', 'E99235', 'E28218', 'E89610', 'E65991', 'E23832', 'E53010', 'E26027', 'E37598', 'E29703', 'E13393', 'E14357', 'E11876', 'E26185', 'E84145', 'E55292', 'E29409', 'E31114', 'E52566', 'E69203', 'E01151', 'E63654', 'E58367', 'E65757', 'E23781', 'E20214', 'E28408', 'E47094', 'E85610', 'E15507', 'E51486', 'E01259', 'E99873', 'E02037', 'E05410', 'E11081', 'E01817', 'E59601', 'E73962', 'E18012', 'E61944', 'E56594']

#todo: need adaptation to zipped reading


def read_file(f, file_path, bearing):
    _dir = os.path.split(file_path)[0]
    _set = os.path.split(file_path)[1].split('_-_')[0]

    X = pd.read_csv(f)
    X['Case'] = X.Case.map(lambda x: str(x)).astype('str')

    """
    target = pd.read_csv(os.path.join(_dir, f"{_set}_-_Case_to_Problem.csv"))
    nuisance = pd.read_csv(os.path.join(_dir, f"{_set}_-_Nuisance_Cases.csv"))
    nuisance['Problem'] = 'None'
    target = pd.concat((target, nuisance), axis=0)
    target['Case'] = target.Case.map(lambda x: str(x)).astype('str')

    X = pd.read_csv(f)
    X['Case'] = X.Case.map(lambda x: str(x)).astype('str')

    X = pd.merge(X, target, on='Case', how='right')

    X = X[X.Problem.isin(FAULTS)]
    X = X[X.Event.isin(EVENTS)]

    X['Problem'] = X.Problem.map(lambda x: FAULTS.index(x))
    X['Event'] = X.Event.map(lambda x: EVENTS.index(x))

    X.columns = [c.lower() for c in X.columns]
    """

    return X



def read_data(file_path, task: dict = None, filters: dict = None):

    def ffilter(dirs, files):
        files = [f for f in files if 'Events_and_Parameters' in f]
        return dirs, files

    EP = b.read_dataset(file_path, None, ffilter=ffilter, fread_file=read_file, fprocess=None,
                          show_pbar=True, data_file_deep=3)
    EP = EP[0]
    EP['Case'] = EP.Case.map(lambda x: str(x)).astype('str')

    def ffilter(dirs, files):
        files = [f for f in files if 'Case_to_Problem' in f]
        return dirs, files

    CP = b.read_dataset(file_path, None, ffilter=ffilter, fread_file=read_file, fprocess=None,
                          show_pbar=True, data_file_deep=3)
    CP = CP[0]


    def ffilter(dirs, files):
        files = [f for f in files if 'Nuisance_Cases' in f]
        return dirs, files

    NC = b.read_dataset(file_path, None, ffilter=ffilter, fread_file=read_file, fprocess=None,
                          show_pbar=True, data_file_deep=3)
    NC = NC[0]

    NC['Problem'] = 'None'

    target = pd.concat((CP, NC), axis=0)
    target['Case'] = target.Case.map(lambda x: str(x)).astype('str')


    X = pd.merge(EP, target, on='Case', how='right')

    X = X[X.Problem.isin(FAULTS)]
    X = X[X.Event.isin(EVENTS)]

    X['Problem'] = X.Problem.map(lambda x: FAULTS.index(x))
    X['Event'] = X.Event.map(lambda x: EVENTS.index(x))

    X.columns = [c.lower() for c in X.columns]

    return X
