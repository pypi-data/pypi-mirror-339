<template tpl_id="study_viewer">
    <div  class="flex-use-height">
        <div class="controls d-flex">


            <button id="btn-back" class="btn btn-outline-primary mr-2" style="width: 150px;" onclick="study_viewer.back();">
                <i class="fas fa-arrow-left"></i> 
            </button>
            <button id="btn-forward" class="btn btn-outline-primary mr-2" style="width: 150px;"onclick="study_viewer.next();">
             <i class="fas fa-arrow-right"></i>
            </button>
            <
        </div>
        <div class="row">

            <div class="col-8">
                <div class="study-doi">
                    <a href="#" class="study-doi-link" target="_blank">
    
                    </a>
                </div>
                <div class="study-name fw-bold">
    
                </div>
               <div class="abstract">
    
               </div> 
    
            </div>
            <div class="col-4 ">
                <div class="study-fields">
    
                </div>
            
            </div>
    
    
        </div>
    </div>
    


</template>
<template tpl_id="study_item_int">
    
    <div class="m-1 card">
        <span class="study-field-title"></span><br />
        <input type="text" class="study-field-value m-1 mx-auto d-block" />

    </div>


 </template>   
 <template tpl_id="study_item_multibool">
    
    <div class="m-1 card">
        <span class="study-field-title"></span><br />
        
        <div class="btn-group flex-wrap multibool-options" role="group" style="max-width: 500px;">
    
          </div>
          
    </div>
 </template>   
 <template tpl_id="study_item_multibool_item">
    <div>
        <input type="checkbox" style="" class="btn-check" autocomplete="off" />
        <label class="btn btn-outline-primary rounded-0" for="">Three</label>
    </div>
    
 </template>
 <template tpl_id="study_item_select">
    
    <div class="m-1 card">
        <span class="study-field-title"></span><br />
        
        <div class="btn-group flex-wrap select-options" role="group" style="max-width: 500px;">
    
          </div>
          
    </div>
 </template>   
 <template tpl_id="study_item_select_item">
    <div>
        <input type="checkbox" style="" class="btn-check" autocomplete="off" />
        <label class="btn btn-outline-primary rounded-0" for="">Three</label>
    </div>
    
 </template>

<script>
    var study_viewer = {};
    study_viewer.list=undefined;
    study_viewer.index=0;
    study_viewer.start_list = function(first_id,first_index,study_list_request_data){
        study_viewer._view(first_id);
        DoRequest("get_study_list_ids",study_list_request_data, function (data) {
            if (data.value) {
                study_viewer.list=data.value;
                study_viewer.index=first_index;
            }
        });


    }

    study_viewer.next = function(){
        if (study_viewer.list==undefined)return;
        if (study_viewer.index<study_viewer.list.length-1){
            study_viewer.index++;
            study_viewer._view(study_viewer.list[study_viewer.index]);
        }else{
            alert("no more studies in this project");
        }
    }
    study_viewer.back = function(){
        if (study_viewer.list==undefined)return;
        if (study_viewer.index>0){
            study_viewer.index--;
            study_viewer._view(study_viewer.list[study_viewer.index]);
        }else{
            alert("no more studies in this project");
        }
    }



    study_viewer.view=function(study_id){
        study_viewer.list=undefined;
        study_viewer.index=0;
        study_viewer._view(study_id);
    }

    study_viewer._view=function(study_id){
        node = $("#main-view-content").tpl("study_viewer");
        DoRequest("get_study", {"token":session_token,"project":selected_project,"study_id":study_id}, function (data) {
            if (data.value) {
                node.find(".study-name").text(data.value.study.name);
                node.find(".study-doi-link").text(data.value.study.doi);
                node.find(".study-doi-link").attr("href","https://doi.org/"+data.value.study.doi);
                node.find(".abstract").text(data.value.study.abstract);

                $.each(data.value.project.fields, function (index, field) {
                    let fieldnode=undefined;
                    switch(field.type){
                        case "int":
                            fieldnode = $(".study-fields").appendtpl("study_item_int");
                            break;
                        case "select":

                            fieldnode = $(".study-fields").appendtpl("study_item_select");
                            fieldnode.attr("id","fld_"+field.name);
                            $.each(field.reference, function (name, item) {
                                let onode=fieldnode.find(".select-options").appendtpl("study_item_select_item");
                                onode.find("label").text(name);
                                onode.find("value").val(name);
                                onode.click(function(){
                                        fieldnode.find(".select-options").find(".btn-check").removeAttr("checked");
                                        $(this).find(".btn-check").attr("checked","checked");
                                        
                                    });
                                onode.find("label").attr("for","fld_"+field.name+"_"+name);
                            });
                            break;
                        case "multibool":
                            fieldnode = $(".study-fields").appendtpl("study_item_multibool");
                            $.each(field.reference, function (name, item) {
                                let onode=fieldnode.find(".multibool-options").appendtpl("study_item_multibool_item");
                                onode.find("label").text(name);
                                onode.find("input").attr("id","fld_"+field.name+"_"+name);
                                onode.find("label").attr("for","fld_"+field.name+"_"+name);
                            });
                            break;
                        default:
                            console.log("unknown field type");
                            return;
                    }   
                    fieldnode.find(".study-field-title").text(field.caption);
                    fieldnode.find(".study-field-value").val(data.value.study["data_"+field.name]);

                });
  
            }
        });
    }


    document.addEventListener("keydown", function(event) {
        if (event.key === "ArrowLeft") {
            study_viewer.back();
        } else if (event.key === "ArrowRight") {
            study_viewer.next();
        }
    });

</script>