# -*- coding: utf-8 -*-
"""ENVM_20250406_00.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1wzKbmY_XWUIfXfPSvBEF3MLECWLmZcco

# EnvFileManager
ipynbãƒ•ã‚¡ã‚¤ãƒ«ã‚’envãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›ã—ã¾ã™


```
2025/02/20 0.1.0 å®Œæˆ
2025/03/02 PyPIã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
2025/03/03 0.1.1 GitHubã®DebugHelperã§ã¯ãªãã€PyPIã®ã‚’ä½¿ã†ã‚ˆã†ã«ã—ãŸã€‚
2025/03/03 0.2.0 EnvManagerã‚‚ä¸€ç·’ã«PyPIã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚ˆã†ã«ã—ãŸã€‚
2025/03/03 0.1.0 ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ããªããªã£ãŸã®ã§ã€ç•ªå·ã‚’æŒ¯ã‚Šç›´ã—ãŸã€‚
2025/03/03 0.1.1 ç´°ã‹ã„éƒ¨åˆ†ã§æ”¹è‰¯
2025/03/11 0.2.0 get_env_varã§boolå€¤ãŒã†ã¾ãè¿”ã›ãªã„ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸã®ã§ä¿®æ­£
2025/03/11 0.2.6 PyPIã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å¤±æ•—ã—ãŸãŸã‚ã€ç•ªå·ã‚’å¤‰ãˆã‚‹ã€‚
2025/04/06 1.0.0 å…¬é–‹ã«å‘ã‘ã€.env ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’å¼•æ•° env_dir ã§æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã—ãŸã€‚
```

# EnvFileManager

## 1. GDrive æ¥ç¶š
"""

# @title a. GDrive æ¥ç¶š
from google.colab import drive
drive.mount('/content/drive')

"""## 2. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®šç¾©"""

# @title a. EnvFileManager å®šç¾©{"form-width":"400px"}
import os
import yaml
import json
from pathlib import Path
get_ipython().system( "pip install an_debughelper" )
from an_debughelper import DebugHelper

Pid_env_folder = Path( "/content/drive/MyDrive/env" )
Pid_env_config_file = Path( "config.yaml" )

class EnvFileManager:
    def __init__(self, ipynb_file, config_path = Pid_env_folder / Pid_env_config_file ):
        """
        ç’°å¢ƒå¤‰æ•°ã‚’åˆ†é¡ã—ã¦.envãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹

        :param ipynb_file : å¤‰æ›ã™ã‚‹ ipynb ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        :param config_path: æŠ½å‡ºå¤‰æ•°ãƒ«ãƒ¼ãƒ«å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«
        """
        if not Path( config_path ).exists():
            raise FileNotFoundError(f"{config_path} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        self.debug = DebugHelper()
        self.debug.enable_log_to_file_stdout()
        self.debug.enable_log_to_file_stderr()
        self.debug.enable_timestamp()

        self.ipynb_file = ipynb_file
        self.config = self.load_config(config_path)

        self.debug.log_step(f"EnvFileManager åˆæœŸåŒ–", success=None)
        self.debug.log_step(f"å¯¾è±¡ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯: {self.ipynb_file}", char = "ğŸ“„")

        if not os.path.exists( Pid_env_folder ):
            os.makedirs( Pid_env_folder )
            self.debug.log_step( "envãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ç”¨ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ", success = True )
        # self.debug.run_command( "ls -l '/content/drive/MyDrive/Colab Notebooks/'", stdout = True, stderr = True )
        if not os.path.exists(self.ipynb_file):
            raise FileNotFoundError(f"{self.ipynb_file} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        else:
            self.debug.log_step(f"{self.ipynb_file} ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ", success=True)

    def load_config(self, config_path):
        """YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€"""
        with open(config_path, "r") as file:
            return yaml.safe_load(file)

    def extract_env_from_ipynb(self):
        """ç‰¹å®šã®ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ã®ç’°å¢ƒå¤‰æ•°ã‚’æŠ½å‡ºã—ã€é©åˆ‡ãª.envãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†é¡"""
        env_vars = {}  # { "ãƒ•ã‚¡ã‚¤ãƒ«å": [å¤‰æ•°ãƒªã‚¹ãƒˆ] }
        start_marker = "# START_ENV"
        end_marker = "# END_ENV"
        within_section = False

        i = 0
        with open(self.ipynb_file, "r", encoding="utf-8") as f:
            notebook = json.load(f)
            for cell in notebook.get("cells", []):
                if cell.get("cell_type") == "code":
                    for line in cell.get("source", []):
                        i += 1
                        self.debug.log_step( f"No.{ i }: {line}", end = "", success = None)
                        if start_marker in line:
                            within_section = True
                            self.debug.log_step( "Start marker", success = None )
                            continue
                        if end_marker in line:
                            within_section = False
                            self.debug.log_step( "End marker", success = None )
                            continue
                        if within_section:
                            if "os.environ" in line:  # ç’°å¢ƒå¤‰æ•°ã®å®šç¾©
                                env_vars.setdefault( Path( Pid_env_folder ) / Path( "env_settings.env" ), []).append(line)
                                self.debug.log_step( f"æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ã¾ã™ : settings_env.env", char = "âœï¸" )
                            else:  # é€šå¸¸ã®å¤‰æ•°å®šç¾©
                                for prefix, env_file in self.config["env_rules"].items():
                                    if line.strip().startswith(prefix):
                                        env_vars.setdefault(Path( Pid_env_folder ) / Path( env_file ), []).append(line)
                                        self.debug.log_step( f"æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ã¾ã™ : { prefix }", char = "âœ’ï¸" )
                                        break
                                else:
                                    env_vars.setdefault(self.config["env_rules"]["default"], []).append(line)

        # åˆ†é¡ã—ãŸç’°å¢ƒå¤‰æ•°ã‚’ä¿å­˜
        for file, lines in env_vars.items():
            with open(file, "w", encoding="utf-8") as f:
                f.writelines(lines)
            self.debug.log_step(f"{file} ã«ç’°å¢ƒå¤‰æ•°ã‚’ä¿å­˜", success=True)

# %%writefile /content/drive/MyDrive/code/envmanager.py
# @title b. EnvManager å®šç¾©
import os
import sys
import yaml
from pathlib import Path

get_ipython().system("pip install an_DebugHelper")
from an_debughelper import DebugHelper
get_ipython().system("pip install python-dotenv")
from dotenv import load_dotenv, find_dotenv


class EnvManager:
    """
    è¤‡æ•°ã® .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ç’°å¢ƒå¤‰æ•°ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å®¹æ˜“ã«ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚
    ç‰¹ã« settings_git.env ã‚’æœ€åˆã«èª­ã¿è¾¼ã¿ã€GitHub é–¢é€£ã®æƒ…å ±ï¼ˆgit_username, git_PersonalAccessTokenï¼‰
    ã‚’åˆ©ç”¨å¯èƒ½ã«ã—ã¾ã™ã€‚
    """
    def __init__(self, env_dir = "/content/drive/MyDrive/env/", env_files=None):
        """
        åˆæœŸè¨­å®š
        args:
            env_dir( str ) : .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€( "/content/drive/MyDrive/env" ã‚’æ¨å¥¨)
            env_files( str ) : èª­ã¿è¾¼ã‚€ .env ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆï¼ˆsettings_git.env ã‚’å«ã‚ã‚‹ã“ã¨ã‚’æ¨å¥¨ï¼‰
        """
        self.debug = DebugHelper( instance_name = "EnvManager" )
        self.debug.enable_timestamp()
        self.debug.enable_log_to_file_stdout()
        self.debug.enable_log_to_file_stderr()

        self.env_dir = Path( env_dir )
        # ä»–ã®.envãƒ•ã‚¡ã‚¤ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        self.env_files = env_files if env_files is not None else []
        self.load_all_envs()

    def load_all_envs(self):
        """æŒ‡å®šã•ã‚ŒãŸå…¨ã¦ã® .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹"""
        for env_file in self.env_files:
            env_path = self.env_dir / env_file
            if env_path.exists():
                load_dotenv( dotenv_path = env_path, override = False )
                self.debug.log_step(f"{env_file} ãŒæ­£å¸¸ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚", success=True)
            else:
                self.debug.log_step(f"{env_file} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚", success=False)
                raise Exception(f"{env_file} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")

    def get_env_var(self, var_name, type="string"):
        """
        ç’°å¢ƒå¤‰æ•°ã®å€¤ã‚’è¿”ã™
        Supported types: "string", "int", "float", "bool",
                         "string_array", "int_array", "float_array"
        """
        allowed_types = ["string", "int", "float", "bool", "string_array", "int_array", "float_array"]
        if type not in allowed_types:
            raise ValueError(f"Invalid type '{type}'. Allowed types are {allowed_types}.")

        # ã¾ãšç’°å¢ƒå¤‰æ•°ã®ç”Ÿã®æ–‡å­—åˆ—ã‚’å–å¾—
        value = os.getenv(var_name, "")

        if type == "bool":
            if value.lower() == "true":
                return True
            elif value.lower() == "false":
                return False
            else:
                raise ValueError(f"Invalid boolean value for '{var_name}': {value}")
        elif type == "string":
            return value
        elif type == "int":
            return int(value) if value else 0
        elif type == "float":
            return float(value) if value else 0.0
        elif type in ["string_array", "int_array", "float_array"]:
            # é…åˆ—å‹ã®å ´åˆã€ç’°å¢ƒå¤‰æ•°ã®å€¤ã¯ãƒªã‚¹ãƒˆãƒªãƒ†ãƒ©ãƒ«ï¼ˆä¾‹: '["abc", "def"]'ï¼‰ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å‰æ
            try:
                parsed = list.literal_eval(value)
                if not isinstance(parsed, list):
                    raise ValueError(f"Value for '{var_name}' is not a list.")
            except Exception as e:
                raise ValueError(f"Unable to parse array value for '{var_name}': {value}. Error: {e}")

            if type == "string_array":
                return [str(item) for item in parsed]
            elif type == "int_array":
                return [int(item) for item in parsed]
            elif type == "float_array":
                return [float(item) for item in parsed]
        else:
            raise ValueError("Unsupported type")

"""## 3. ãƒ†ã‚¹ãƒˆ"""

# @title a. ãƒ†ã‚¹ãƒˆ{"form-width":"400px"}
# **ä½¿ç”¨ä¾‹**
if __name__ == "__main__":

    manager = EnvFileManager( ipynb_file = "/content/drive/MyDrive/Colab Notebooks/CENV_20250302_00.ipynb" )
    manager.extract_env_from_ipynb()
    # # `.ipynb` ã‹ã‚‰ `.env` ã‚’ä½œæˆ
    # if manager.extract_env_from_ipynb():from google.colab import drive
    # drive.mount('/content/drive')

    #     # `.env` ã‚’ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã‚³ãƒ”ãƒ¼
    #     manager.copy_env_to_current_dir()

# @title b. EnvManagerãƒ†ã‚¹ãƒˆ
if __name__ == "__main__":
    envmanager = EnvManager( env_files = [ "settings_git.env", "settings_ven.env"  ] )
    envmanager.load_all_envs()
    print( envmanager.get_env_var( "Ven_base_folder" ) )
    print( envmanager.get_env_var( "Ven_app_folder", type = "string" ) )